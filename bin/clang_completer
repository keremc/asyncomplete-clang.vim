#!/usr/bin/env python2

from __future__ import print_function

import json

from clang.cindex import Config, Index

Config.set_compatibility_check(False)

idx = Index.create()
trans_units = {}


def collect_args(path):
    return [
        '-std=c++14',
        '-I/usr/include/c++/7',
        '-I/usr/include/c++/7/x86_64-redhat-linux',
        '-I/usr/include/c++/7/backward',
        '-I/usr/local/include',
        '-I/usr/lib64/clang/4.0.1/include',
        '-I/usr/include'
    ]


def get_tu(path):
    if path in trans_units:
        tu = trans_units[path]
    else:
        tu = idx.parse(path, collect_args(path))
        trans_units[path] = tu
    return tu


def process_comp_str(string):
    word = ''
    menu = ''

    if string.availability.name in ['NotAvailable', 'NotAccessible']:
        return None
    elif len(string) == 1:
        word = string[0].spelling
    else:
        for chunk in string:
            if chunk.isKindResultType():
                menu += chunk.spelling
                menu += ' '
            elif chunk.isKindTypedText():
                word = chunk.spelling
                menu += chunk.spelling
            else:
                menu += chunk.spelling

    return {'word': word, 'menu': menu, 'dup': 1}


def get_comps(path, line, col, buf):
    comps = []

    tu = get_tu(path)
    results = tu.codeComplete(path, line, col, [(path, buf)], True)

    for res in results.results:
        comp = process_comp_str(res.string)
        if comp is None or comp in comps:
            continue
        comps.append(comp)

    return comps


def process(req_type, req):
    if req_type == 'parse':
        tu = get_tu(str(req['path']))
        tu.reparse()
    elif req_type == 'comp':
        return {'comps': get_comps(
            str(req['path']),
            req['line'],
            req['col'],
            str(req['buf'])
        )}


while True:
    line = raw_input()

    req = json.loads(line)
    req_id = req['id']
    req_type = req['type']

    resp = process(req_type, req)

    if resp is None:
        continue

    resp['id'] = req_id
    resp['type'] = req_type
    print(json.dumps(resp))
